#!/bin/bash

killall -USR1 dunst

lockdir="/tmp/lockscreen-$(whoami)"
rm -r "$lockdir"
mkdir "$lockdir"

montage -geometry '1920x1080+0+0' "wallpapers/0071 - 5i61fKs.jpg" "wallpapers/0081 - ms9u0xG.jpg" "$lockdir/final.png"

IFS=$'\n'
for window in $(wmctrl -lG | awk '{ print $1, $3, $4, $5, $6 }'); do
    IFS=' ' read w_id w_x w_y w_width w_height <<< "$window"
    let w_x/=2
    let w_y/=2
    let w_width+=6
    let w_height+=6

    echo "${w_id}: $w_x, $w_y (${w_width}x${w_height})"

    maim -i "$w_id" -g "${w_width}x${w_height}+0+0" --format png /dev/stdout |
        convert png:- \
            -resize "$((w_width / 6))x$((w_height / 6))" \
            -sample "${w_width}x${w_height}" \
            "$lockdir/$w_id.png"

    composite -blend '40%' \
         -geometry "+${w_x}+${w_y}" \
        "$lockdir/$w_id.png" \
        "$lockdir/final.png" \
        "$lockdir/final.png"
done

i3lock -ni "$lockdir/final.png"; killall -USR2 dunst
